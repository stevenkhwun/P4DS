---
title: "Running SQL using <b>pandas</b>"
author: "SW"
date: "Last updated: `r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 2
    number_sections: yes
    toc_float:
      collapsed: no
      #smooth_scroll: yes
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{python echo=FALSE}
import warnings
warnings.filterwarnings('ignore')
```


<hr>

<font size="6">Introduction</font>

This page is meant to provide some examples of how various SQL operations would be performed using pandas.

As is customary, we import pandas and NumPy as follows:

```{python}
import pandas as pd
import numpy as np
```

Most of the examples will utilize the `tips` dataset found within pandas tests. We’ll read the data into a `DataFrame` called `tips` and assume we have a database table of the same name and structure.

```{python}
url = (
    "https://raw.githubusercontent.com/pandas-dev"
    "/pandas/main/pandas/tests/io/data/csv/tips.csv"
    )

tips = pd.read_csv(url)
tips.head(5)
```


We will also use the `usvideos` dataset in some examples.

```{python}
usvideos_url = (
"https://raw.githubusercontent.com/OrysyaStus/SeismicBlog/master/Data_Visualizations"
"/Dynamic_Visuals_Using_Date_Range_Slicers_Pt1/data/USvideos.csv"
)
usvideos = pd.read_csv(usvideos_url)
usvideos.head()
```
 
 
# Copies vs. in place operations

Most pandas operations return copies of the `Series`/`DataFrame`. To make the changes “stick”, you’ll need to either assign to a new variable:

```{python eval=FALSE}
# assign to a new variable
sorted_df = df.sort_values("col1")
```

or overwrite the original one:

```{python eval=FALSE}
df = df.sort_values("col1")
```


# SELECT

In SQL, selection is done using a comma-separated list of columns you’d like to select (or a * to select all columns):


```{SQL eval=FALSE}
SELECT total_bill, tip, smoker, time
FROM tips;
```

With pandas, column selection is done by passing a list of column names to your DataFrame:

```{python}
tips[["total_bill", "tip", "smoker", "time"]]
```

Calling the `DataFrame` without the list of column names would display all columns (akin to SQL’s *).

## Add a calculated column

In SQL, you can add a calculated column:

```{SQL eval=FALSE}
SELECT *, tip/total_bill as tip_rate
FROM tips;
```

With pandas, you can use the `DataFrame.assign()` method of a `DataFrame` to append a new column:

```{python}
tips.assign(tip_rate=tips['tip'] / tips['total_bill'])
```


```{python}
tips.nlargest(10 + 5, columns="tip").tail(10)
```

```{python}
tips.nlargest(10, columns="tip").tail(10)
```

[pandas.DataFrame.nlargest](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.nlargest.html)

[pandas.DataFrame.nsmallest](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.nsmallest.html)
